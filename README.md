# 大众点评评论的4分类20个多任务学习

## 0 写在前
>> 多任务学习是继深度学习能够解决单个分类或回归问题之后的一个重要研究方向，它提出的主要背景是，算法工程师总能希望进行一次训练，可以将多个相关的任务目标或不那么相关的目标进行统一的学习，想法很容易理解，这样Multi Task Learing既可以找到同一个对象的多个任务（诸如一个人的身高、体重、年龄、收入等多个目标的预测）相关联系，以便于更好得获得高层语义理解（如任务画像的多个标签），同时还可以并行学习，节约大量的时间。MTL正是在这样的背景之下提出，但是想法遭遇了现实问题的抵抗，容易想到的是，每个任务的loss function评价体系不一样怎么处理、在训练过程中，每个Task的权重怎么进行有效学习，复杂的任务如何避免遭受一些简单学习任务的影响（换句话说，复杂任务的loss死活下降不下去，而简单任务的准确度accuracy却已接近于、假使你也已经训练出来了，那么如何评价这个MTL模型的好坏也是一个要研究的问题。  
>> 幸好，前人已经做了大量的基础研究工作。针对MTL，我们能够找到大体三种学习方法：  
>>> * （1）基于特征分享的多任务学习方法；  
>>> * （2）基于模型参数分享的多任务学习方法；  
>>> * （3）基于深度学习的多任务学习方法。  
&nbsp; &nbsp; 对于前两种方法，大多是SVM等机器学习的方法，不再赘述，详情可参考[中科大博士的一篇论文](http://cdmd.cnki.com.cn/Article/CDMD-10358-1018095965.htm)进行查找。本文基于深度学习的多任务学习方法，讲2种方法，一种是手动调参（loss_weight），任务学习个数不受限制，第二种方法则是重构loss_function，将同方差Uncertainty（可以理解为求使多个任务loss的乘积最小值的一组loss_weight参数求解），对于回归和分类2个任务学习的代码也展示在[这里]()。  

## 1 项目介绍
### 1.1 背景
```
在自然语言处理中，有一个常见的问题就是对客户的评价进行分析。 这些用户评论中，包含了大量的有用信息，例如情感分析，或者相关事实描述。 例如:

“味道不错的面馆，性价比也相当之高，分量很足～女生吃小份，胃口小的，可能吃不完呢。环境在面馆来说算是好的，至少看上去堂子很亮，也比较干净，一般苍蝇馆子还是比不上这个卫生状况的。中午饭点的时候，人很多，人行道上也是要坐满的，隔壁的冒菜馆子，据说是一家，有时候也会开放出来坐吃面的人。“

```
* 首先情感是正向的，除此之外我们还能够进行知道这个的几个事实描述：1. 性价比比较高； 2. 装修比较好； 3. 分量足。  
* 这些信息是非常重要宝贵的，不论是对于公司进行商业分析或者要建立一个搜索引擎排序，这些信息都是重要的参考因素。 那么在这个时候，我们就需要进行文本的情感分类了  

### 1.2 项目内容

```
这个问题我们希望的是，输入一句话，输出是这句话对于以下6大类，20小类进行打标，对于每个小类而言，都会有<正面情感, 中性情感, 负面情感, 情感倾向未提及 >  这4个类别。

>  位置: location  
>>>> 交通是否便利(traffic convenience)  
>>>> 距离商圈远近(distance from business district)  
>>>> 是否容易寻找(easy to find)  
> 服务(service)  
>>>> 排队等候时间(wait time)  
>>>> 服务人员态度(waiter’s attitude)  
>>>> 是否容易停车(parking convenience)  
>>>> 点菜/上菜速度(serving speed)  
>  价格(price)  
>>>> 价格水平(price level)  
>>>> 性价比(cost-effective)  
>>>> 折扣力度(discount)  
>  环境(environment)  
>>>> 装修情况(decoration)  
>>>> 嘈杂情况(noise)  
>>>> 就餐空间(space)  
>>>> 卫生情况(cleaness)  
>  菜品(dish)  
>>>> 分量(portion)  
>>>> 口感(taste)  
>>>> 外观(look)  
>>>> 推荐程度(recommendation)  
>  其他(others)  
>>>> 本次消费感受(overall experience)  
>>>> 再次消费的意愿(willing to consume again)  
```
```
而为了方便训练数据的标标注，训练数据中，<** 正面情感, 中性情感, 负面情感, 情感倾向未提及 > ** 分别对应与 (1, 0, -1, -2).  
例如说，“味道不错的面馆，性价比也相当之高，分量很足～女生吃小份，胃口小的，可能吃不完呢。环境在面馆来说算是好的，至少看上去堂子很亮，也比较干净，一般苍蝇馆子还是比不上这个卫生状况的。中午饭点的时候，人很多，人行道上也是要坐满的，隔壁的冒菜馆子，据说是一家，有时候也会开放出来坐吃面的人。  
____  
这句话对应的结果就是：  
交通是否便利(traffic convenience) -2  
距离商圈远近(distance from business district) -2  
是否容易寻找(easy to find) -2  
排队等候时间(wait time) -2  
服务人员态度(waiter’s attitude) -2  
是否容易停车(parking convenience) -2  
点菜/上菜速度(serving speed) -2  
价格水平(price level) -2  
性价比(cost-effective) 1  
折扣力度(discount) -2  
装修情况(decoration) 1  
嘈杂情况(noise) -2  
就餐空间(space) -2  
卫生情况(cleaness) 1  
分量(portion) 1  
口感(taste) 1  
外观(look) -2  
推荐程度(recommendation) -2  
次消费感受(overall experience) 1  
再次消费的意愿(willing to consume again) -2  
```
### 1.3 项目模型的定位
> 乍眼一看，该项目的6个基本问题和20个小类很容易给人迷惑的印象，再加上该问题在业界的名称叫做```文本细粒度分类```，更容易让习惯了二分类单任务的人产生怀疑。但细细品读，可以发现其实是20个任务的4分类问题。而且20个任务在文本语义上是有联系的，要不也不会称之为细粒度或者6个大类。因此，在前提判断上，我们认为是可以利用深度学习算法进行训练的。  

### 2 

### 2.4 最终的网络结构
```
Model: "model_1"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            (None, 300)          0                                            
__________________________________________________________________________________________________
embedding_1 (Embedding)         (None, 300, 300)     60000000    input_1[0][0]                    
__________________________________________________________________________________________________
spatial_dropout1d_1 (SpatialDro (None, 300, 300)     0           embedding_1[0][0]                
__________________________________________________________________________________________________
bidirectional_1 (Bidirectional) (None, 300, 160)     243840      spatial_dropout1d_1[0][0]        
__________________________________________________________________________________________________
global_average_pooling1d_1 (Glo (None, 160)          0           bidirectional_1[0][0]            
__________________________________________________________________________________________________
global_max_pooling1d_1 (GlobalM (None, 160)          0           bidirectional_1[0][0]            
__________________________________________________________________________________________________
concatenate_1 (Concatenate)     (None, 320)          0           global_average_pooling1d_1[0][0] 
                                                                 global_max_pooling1d_1[0][0]     
__________________________________________________________________________________________________
out_1 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_2 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_3 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_4 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_5 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_6 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_7 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_8 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_9 (Dense)                   (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_10 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_11 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_12 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_13 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_14 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_15 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_16 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_17 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_18 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_19 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
__________________________________________________________________________________________________
out_20 (Dense)                  (None, 4)            1284        concatenate_1[0][0]              
==================================================================================================
Total params: 60,269,520
Trainable params: 60,269,520
Non-trainable params: 0

```
